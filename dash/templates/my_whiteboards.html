{% extends 'base.html' %}
{% load static %}

{% block site_name %}Moje Tablice{% endblock %}
{% block site_actions %}
  <a class="btn btn-primary btn-sm d-none d-sm-inline-block" role="button" href="#" data-bs-toggle="modal" data-bs-target="#nowaTablicaModal">
    <i class="fas fa-plus fa-sm text-white-50"></i>&nbsp;Nowa Tablica
  </a>
{% endblock %}
{% block content %}
  <div id="cards" class="row" style="overflow-y: scroll;height: 70vh;">
    {% if tables %}
      {% for table in tables %}
        <div class="col-md-6 col-xl-3 mb-4">
          <div class="card shadow border-left-success py-2">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: transparent;">
              <span class="text-primary fw-bold m-0 text-wrap">{{ table.user_room_name }}</span>
              <div class="dropdown no-arrow">
                <button class="btn btn-link btn-sm dropdown-toggle" aria-expanded="false" data-bs-toggle="dropdown" type="button">
                  <i class="fas fa-ellipsis-v text-gray-400"></i>
                </button>
                <div class="dropdown-menu shadow dropdown-menu-end animated--fade-in">
                  <p class="text-center dropdown-header">Akcje</p>
                  <a class="dropdown-item disabled" href="#">Udostępnij</a>
                  <a class="dropdown-item rename-board" href="#"
                     data-board-id="{{ table.room_name }}"
                     data-board-name="{{ table.user_room_name }}"
                     data-bs-toggle="modal"
                     data-bs-target="#renameBoardModal">
                    Zmień nazwę
                  </a>
                  <div class="dropdown-divider"></div>
                  <!-- Link otwierający modal, przekazuje id i nazwę tablicy -->
                  <a class="dropdown-item delete-board" href="#"
                     data-board-id="{{ table.room_name }}"
                     data-board-name="{{ table.user_room_name }}"
                     data-bs-toggle="modal"
                     data-bs-target="#deleteBoardModal">
                    Usuń
                  </a>
                </div>
              </div>
            </div>
            <div class="card-body" style="background: transparent;">
              <div class="row g-0 align-items-center">
                <div class="col me-2">
                  <div class="text-uppercase text-primary fw-bold text-xs mb-1">
                    <span class="d-lg-flex justify-content-lg-start">Edytowano:&nbsp<b>{{ table.last_update }}</b></span>
                    <span class="d-lg-flex justify-content-lg-start">Utworzono: {{ table.created_at }}</span>
                  </div>
                  <div class="text-dark fw-bold h5 mb-0">
                    <hr>
                    <a href="{% url 'collab:room' table.room_name %}">
                      <button class="btn btn-primary" type="button">Edytuj Tablice</button>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="col-md-6 col-xl-3 mb-4">
        <div class="card shadow border-left-danger py-2">
          <div class="card-header d-flex justify-content-between align-items-center" style="background: transparent;">
            <span class="text-primary fw-bold m-0">Brak tablic</span>
          </div>
          <div class="card-body" style="background: transparent;">
            <div class="row g-0 align-items-center">
              <div class="col me-2">
                <div class="text-uppercase text-primary fw-bold text-xs mb-1">
                  <span class="d-lg-flex justify-content-lg-start">Utwórz nową tablicę</span>
                </div>
                <div class="text-dark fw-bold h5 mb-0">
                  <hr>
                  <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#nowaTablicaModal">Nowa Tablica</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
{% endblock %}
{% block modals %}
  <!-- Modal: Nowa Tablica -->
  <div class="modal fade" id="nowaTablicaModal" tabindex="-1" aria-labelledby="nowaTablicaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="nowaTablicaModalLabel">Nowa Tablica</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
        </div>
        <form method="POST" action="{% url 'my' %}">
          <div class="modal-body">
            {% csrf_token %}
            <div class="mb-3">
              <label for="tablicaNazwa" class="form-label">Nazwa Tablicy</label>
              <input type="text" class="form-control" id="tablicaNazwa" name="room_name" minlength="5" maxlength="17" placeholder="Wprowadź nazwę tablicy" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
            <button type="submit" class="btn btn-primary">Zapisz</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal: Potwierdzenie usunięcia tablicy -->
  <div class="modal fade" id="deleteBoardModal" tabindex="-1" aria-labelledby="deleteBoardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteBoardModalLabel">Potwierdzenie usunięcia tablicy</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
        </div>
        <form method="POST" action="{% url 'my' %}">
          {% csrf_token %}
          <div class="modal-body">
            <p>Czy na pewno chcesz usunąć tablicę <strong id="modalBoardName"></strong>?</p>
            <input type="hidden" name="room_name" id="modalBoardId" value="">
            <input type="hidden" name="_method" value="DELETE">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
            <button type="submit" class="btn btn-danger">Usuń</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal: Zmiana nazwy tablicy -->
  <div class="modal fade" id="renameBoardModal" tabindex="-1" aria-labelledby="renameBoardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="renameBoardModalLabel">Zmień nazwę tablicy</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
        </div>
        <form method="POST" action="{% url 'my' %}">
          {% csrf_token %}
          <div class="modal-body">
            <div class="mb-3">
              <label for="renameBoardInput" class="form-label">Nowa nazwa tablicy</label>
              <input type="text" class="form-control" id="renameBoardInput" name="new_room_name" required maxlength="17" minlength="5">
            </div>
            <!-- Ukryte pole do przekazania identyfikatora tablicy -->
            <input type="hidden" name="room_name" id="renameBoardId" value="">
            <!-- Możesz dodać ukryty input do metody, np. "PUT" lub "PATCH" -->
            <input type="hidden" name="_method" value="PUT">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
            <button type="submit" class="btn btn-primary">Zmień nazwę</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}
{% block extra_script %}
  <!-- Skrypt do obsługi modalu usuwania tablicy -->
  <script>
  // Pobierz referencję do modalu
  var deleteBoardModal = document.getElementById('deleteBoardModal');

  // Nasłuchuj zdarzenia otwarcia modalu
  deleteBoardModal.addEventListener('show.bs.modal', function (event) {
    // Element, który wywołał otwarcie modalu
    var button = event.relatedTarget;
    // Pobierz dane z atrybutów data
    var boardName = button.getAttribute('data-board-name');
    var boardId = button.getAttribute('data-board-id');

    // Ustaw treść i wartość w modalu
    var modalBoardName = deleteBoardModal.querySelector('#modalBoardName');
    var modalBoardId = deleteBoardModal.querySelector('#modalBoardId');

    modalBoardName.textContent = boardName;
    modalBoardId.value = boardId;
  });
  </script>
  <script>
  var renameBoardModal = document.getElementById('renameBoardModal');
  renameBoardModal.addEventListener('show.bs.modal', function (event) {
    // Element, który wywołał otwarcie modalu
    var button = event.relatedTarget;
    // Pobierz aktualną nazwę i identyfikator tablicy z atrybutów data
    var boardName = button.getAttribute('data-board-name');
    var boardId = button.getAttribute('data-board-id');
    // Ustaw wartość pola tekstowego i ukrytego pola
    var inputField = renameBoardModal.querySelector('#renameBoardInput');
    var hiddenField = renameBoardModal.querySelector('#renameBoardId');
    inputField.value = boardName;
    hiddenField.value = boardId;
  });
  </script>
{% endblock %}
